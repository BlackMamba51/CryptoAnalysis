
<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <title>Crypto</title>
</head>
<body class="page">
    <div class="wrapper">
        <div class="content">
            {% load custom_filters %}
            <header class="header">
                <div class="container">
                    <div class="header__secondary">
                        <div class="header__general-info" style="display: flex; ">
                            <div class="general-info__item">Криптовалюты: {{ data.data.total_crypto_dex_currencies|formatNumbers}}</div>
                            <div class="general-info__item">Биржи: {{ data.data.active_exchanges }}</div>
                            <div class="general-info__item">Рын. кап.: ${{ data.data.quote.USD.total_market_cap|formatNumbers }}</div>
                            <div class="general-info__item">Объем за 24ч: {{ data.data.quote.USD.total_volume_24h|formatNumbers }}</div>
                            <div class="general-info__item">Доминирование: BTC: {{ data.data.btc_dominance|floatformat:1 }}% ETH: {{ data.data.eth_dominance|floatformat:1 }}%</div>
                            <div class="general-info__item">Fear&Greed:</div>
                        </div>
                        <div class="header__btn-content">
                            <a class="btn-content__add-coin" href="{% url 'add_crypto' %}">Разместить криптовалюту</a>
                        </div>
                    </div>
                </div>
            </header>
            <section class="added-coins">
                <div class="container">
                    <div class="added-coins__table">
                        <table id="new_coins">
                            <caption>Последние добавленные монеты</caption>
                            <tr class="added-coins__row">
                                <th>#</th>
                                <th>Название</th>
                                <th>Символ</th>
                                <th>Цена</th>
                                <th>Циркулир. предложение</th>
                            </tr>
                            {% for el in db_data %}
                                <tr class="added-coins__row">
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ el.coin_name }}</td>
                                    <td>{{ el.coin_symbol }}</td>
                                    <td>{{ el.coin_price }}</td>
                                    <td>{{ el.coin_count }}</td>
                                </tr>
                            {% endfor %}
                        </table>
                    </div>
                </div>
            </section> 
            <section class="crypto">
                <div class="container">
                    <table id="crypto__table">
                        <tr class="crypto__row sticky">
                            <th>#</th>
                            <th>Название</th>
                            <th>Символ</th>
                            <th>Цена</th>
                            <th>%1ч</th>
                            <th>%24ч</th>
                            <th>%7дн</th>
                            <th>Рын. кап.</th>
                            <th>Объем (24ч)</th>
                            <th>Циркулир. предложение</th>
                        </tr>
                    </table>
                </div>
            </section>
        </div>
    </div> 
</body>
</html>



<script>
    function formatNumber(number) {
        const digits = Math.floor(Math.log10(number)) + 1;
        let label, divisor ;
        if (digits >= 7 && digits < 10) {
            label = 'M';
            divisor = 1e6;
        } else if (digits >= 10 && digits < 13) {
            label = 'B';
            divisor = 1e9;
        } else if (digits >= 13) {
            label = 'T';
            divisor = 1e12;
        } else {
            label = 'K';
            divisor = 1e3;
        }
        return `${(number / divisor).toFixed(2)} ${label}`;
    };



    function fetchCryptoData() {
        console.log("Запрос API отправлен:", new Date().toLocaleTimeString());
        fetch('api/crypto/').then(response => response.json())
        .then(data => {
            console.log(data);
            let cryptoTable = document.getElementById("crypto__table");
            cryptoTable.innerHTML = `<tr class="crypto__row sticky">
                        <th>#</th>
                        <th>Название</th>
                        <th>Символ</th>
                        <th>Цена</th>
                        <th>%1ч</th>
                        <th>%24ч</th>
                        <th>%7дн</th>
                        <th>Рын. кап.</th>
                        <th>Объем (24ч)</th>
                        <th>Циркулир. предложение</th>
                    </tr>`;
            data.forEach((crypto, index) => {
                const coinCapit = Math.round((crypto.quote.USD.market_cap))
                const formattedCoinCapit = coinCapit.toLocaleString('en-US') // Разделяем число на разряды
                const formattedVolume = Math.round(crypto.quote.USD.volume_24h).toLocaleString('en-US')
                let row = `<tr onclick="window.location.href='coin_detail/${crypto.id}'">
                                <td>${index + 1}</td>
                                <td>${crypto.name}</td>
                                <td>${crypto.symbol}</td>
                                <td>${(crypto.quote.USD.price).toFixed(2)}$</td>
                                <td>${(crypto.quote.USD.percent_change_1h).toFixed(2)}%</td>
                                <td>${(crypto.quote.USD.percent_change_24h).toFixed(2)}%</td>
                                <td>${(crypto.quote.USD.percent_change_7d.toFixed(2))}%</td>
                                <td>$${formattedCoinCapit}</td>
                                <td>$${formattedVolume}</td>
                                <td>${formatNumber(crypto.total_supply)}</td>
                            </tr>`;
                cryptoTable.innerHTML += row
            });
            
        });
    };
    setInterval(fetchCryptoData, 60000);
    


    // function fetchBinanceApi() {
    //     fetch('api/binance/').then(response => response.json()).then(data => {
    //         Plotly.newPlot('chart-div', [{
    //             x: data.timestamps,
    //             y: data.prices,
    //             mode: 'lines'
    //         }]);
    //     });
    // };

    window.onload = function () {
        console.log("Страница загружена, запускаем API");
        fetchCryptoData();
        // fetchBinanceApi();
    };
</script>

